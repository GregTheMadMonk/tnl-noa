#!/usr/bin/env bash

BASE="ftp://math.nist.gov/pub/MatrixMarket2/Harwell-Boeing/"
                
PWD=`pwd`
IWD="$PWD"
SPARSE_MATRIX_BENCHMARK="$IWD/sparse-matrix-benchmark-dbg"
STOP_TIME="1"

source ../tnl-env-variables

export CUDA_PROFILE=0
export CUDA_PROFILE_CONFIG="$TNL_SOURCE_DIR/tests/cuda-profiler.conf"
PROCESS_CUDA_PROFILE="$TNL_SOURCE_DIR/tests/process-cuda-profile.pl"
source $TNL_SOURCE_DIR/tests/matrix-market
source $TNL_SOURCE_DIR/tests/florida-matrix-market

export TNL_SPARSE_MATRIX_CHECK_CFG_DESC_FILE="$TNL_SOURCE_DIR/tests/tnl-sparse-matrix-check.cfg.desc"

#MM_MATRICES=""
#FLORIDA_MM_MATRICES=""

#./tnl-sparse-matrix-check-dbg --input-file matrices/MatrixMarket2/misc/cylshell/s3dkq4m2.mtx
#exit

echo "+---------------------------------------------------------------------------------------------------------------------------------------+--------+-------------------+------------------------------------------------------+------------------------------------------------------+------------------------------------------------------+------------------------------------------------------+------------------------------------------------------+---------------------------------------+---------------------------------------+---------------------------------------+---------------------------------------+------------------+------------------------------------------------------+------------------------------------------------------+------------------------------------------------------+------------------------------------------------------+------------------------------------------------------+" > sparse-matrix-benchmark-float.log
echo "|                                                                                                                                       |        |                   |                 COALESCED CSR BLOCK SIZE 16          |                 COALESCED CSR BLOCK SIZE 32          |                 COALESCED CSR BLOCK SIZE 64          |                 COALESCED CSR BLOCK SIZE 128         |                 COALESCED CSR BLOCK SIZE 256         |                              RgCSR  GROUP SIZE 16                             |                              RgCSR  GROUP SIZE 32                             |                  |           COALESCED FAST CSR BLOCK SIZE 32           |           COALESCED FAST CSR BLOCK SIZE 64           |           COALESCED FAST CSR BLOCK SIZE 128          |           COALESCED FAST CSR BLOCK SIZE 256          |           COALESCED FAST CSR BLOCK SIZE 512          |" >> sparse-matrix-benchmark-float.log
echo "|                                               TESTING MATRIX                                                                          |  CSR   |       HYB         |--------------+-------------------+-------------------|--------------+-------------------+-------------------+--------------+-------------------+-------------------+--------------+-------------------+-------------------+--------------+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+      FAST CSR    +--------------+-------------------+-------------------+--------------+-------------------+-------------------+--------------+-------------------+-------------------+--------------+-------------------+-------------------+--------------+-------------------+-------------------+" >> sparse-matrix-benchmark-float.log
echo "|                                                                                                                                       |        |                   |              |       CPU         |       CUDA        |              |       CPU         |       CUDA        |              |       CPU         |       CUDA        |              |       CPU         |       CUDA        |              |       CPU         |       CUDA        |       32          |       64          |       128         |       256         |       32          |       64          |       128         |       256         |                  |              |       CPU         |        CUDA       |              |       CPU         |        CUDA       |              |       CPU         |        CUDA       |              |       CPU         |        CUDA       |              |       CPU         |        CUDA       |" >> sparse-matrix-benchmark-float.log
echo "+---------------------------------------------------------------------------------------------------+---------+------------+------------+--------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+---------+--------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+" >> sparse-matrix-benchmark-float.log
echo "| NAME                                                                                              |  SIZE   | NONZEROS N.| NONZEROS % | GFLOPS | GFLOPS | SPEED-UP | ARTIF. ZEROS | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | ARTIF. ZEROS | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | ARTIF. ZEROS | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | ARTIF. ZEROS | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | ARTIF. ZEROS | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | CMP.EF. | GFLOPS | DICTN. SIZE  | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | DICTN. SIZE  | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | DICTN. SIZE  | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | DICTN. SIZE  | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP | DICTN. SIZE  | GFLOPS | SPEED-UP | GFLOPS | SPEED-UP |" >> sparse-matrix-benchmark-float.log
echo "+---------------------------------------------------------------------------------------------------+---------+------------+------------+--------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+--------+----------+---------+--------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+--------------+--------+----------+--------+----------+" >> sparse-matrix-benchmark-float.log

cp -f sparse-matrix-benchmark-float.log sparse-matrix-benchmark-double.log 
cp -f sparse-matrix-benchmark-float.log sparse-matrix-benchmark-descend-float.log 
cp -f sparse-matrix-benchmark-float.log sparse-matrix-benchmark-descend-double.log 
cp -f sparse-matrix-benchmark-float.log sparse-matrix-benchmark-amd-float.log 
cp -f sparse-matrix-benchmark-float.log sparse-matrix-benchmark-amd-double.log 

echo "+---------------------------------------------------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+-----------------------------------------------------------+" > sparse-matrix-profiling-float.log
echo "|                                                                                                   |                    COALESCED CSR BLOCK SIZE 32            |                    COALESCED CSR BLOCK SIZE 64            |                    COALESCED CSR BLOCK SIZE 128           |                    COALESCED CSR BLOCK SIZE 256           |            RgCSR GROUP SIZE 16 BLOCK SIZE 32              |            RgCSR GROUP SIZE 16 BLOCK SIZE 64              |            RgCSR GROUP SIZE 16 BLOCK SIZE 128             |            RgCSR GROUP SIZE 16 BLOCK SIZE 256             |            RgCSR GROUP SIZE 32 BLOCK SIZE 32              |            RgCSR GROUP SIZE 32 BLOCK SIZE 64              |            RgCSR GROUP SIZE 32 BLOCK SIZE 128             |            RgCSR GROUP SIZE 32 BLOCK SIZE 256             |" >> sparse-matrix-profiling-float.log
echo "|                                        TESTING MATRIX                                             |-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------|-----------+-----------+-----------+-----------+-----------+" >> sparse-matrix-profiling-float.log
echo "|                                                                                                   | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. | Occupancy | Cache Hit |Cache Miss | GldIncoh. | GstIncoh. |" >> sparse-matrix-profiling-float.log
echo "+---------------------------------------------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+" >> sparse-matrix-profiling-float.log

cp -f sparse-matrix-profiling-float.log sparse-matrix-profiling-double.log 
cp -f sparse-matrix-profiling-float.log sparse-matrix-profiling-descend-float.log 
cp -f sparse-matrix-profiling-float.log sparse-matrix-profiling-descend-double.log 
cp -f sparse-matrix-profiling-float.log sparse-matrix-profiling-amd-float.log 
cp -f sparse-matrix-profiling-float.log sparse-matrix-profiling-amd-double.log 

for link in $MM_MATRICES;
do
   echo "###############################################################################################"
   matrix=matrices`echo $link | sed 's/ftp:\/\/math.nist.gov\/pub//'`
   unzipped_matrix=`echo $matrix | sed 's/.gz//'`
   if test ! -e $matrix;
   then
      echo "Matrix $matrix is missing !!! Run the script 'get-matrices' first."
      #echo "Matrix $matrix is missing !!! Run the script 'get-matrices' first." >> sparse-matrix-benchmark.log            
   else
      if test ! -e $unzipped_matrix.float.bin.bz2;
      then
         echo "Missing $unzipped_matrix.float.bin.bz2 !!! Run the script 'convert-matrices'."
         #echo "Missing $unzipped_matrix.float.bin.bz2 !!! Run the script 'convert-matrices'."  >> sparse-matrix-benchmark.log
      else
         gunzip -f $matrix
         echo "Checking with the matrix $unzipped_matrix in single precision ..."
         export CUDA_PROFILE_LOG=$unzipped_matrix.float.log
         $SPARSE_MATRIX_BENCHMARK --input-file $unzipped_matrix.float.bin.bz2 --input-mtx-file $unzipped_matrix --log-file sparse-matrix-benchmark-float.log --stop-time $STOP_TIME --verbose 1
         perl $PROCESS_CUDA_PROFILE $unzipped_matrix.float.log sparse-matrix-profiling-float.log
         gzip $unzipped_matrix
      fi
      if test ! -e $unzipped_matrix.double.bin.bz2;
      then
         echo "Missing $unzipped_matrix.double.bin.bz2 !!! Run the script 'convert-matrices'."
         #echo "Missing $unzipped_matrix.double.bin.bz2 !!! Run the script 'convert-matrices'."  >> sparse-matrix-benchmark.log
      else
         gunzip -f $matrix
         echo "Checking with the matrix $unzipped_matrix in double precison ..."
         export CUDA_PROFILE_LOG=$unzipped_matrix.double.log 
         $SPARSE_MATRIX_BENCHMARK --input-file $unzipped_matrix.double.bin.bz2 --input-mtx-file $unzipped_matrix --log-file sparse-matrix-benchmark-double.log --stop-time $STOP_TIME --verbose 1
         gzip $unzipped_matrix
      fi
      #######
      ## Descend ordering
      ###  
      if test ! -e $unzipped_matrix.descend.float.bin.bz2;
      then
         echo "Missing $unzipped_matrix.descend.float.bin.bz2 !!! Run the script 'convert-matrices'."
      else
         echo "Checking with the matrix $unzipped_matrix.descend in single precision ..."
         export CUDA_PROFILE_LOG=$unzipped_matrix.descend.float.log
         $SPARSE_MATRIX_BENCHMARK --input-file $unzipped_matrix.descend.float.bin.bz2 --input-mtx-file $unzipped_matrix.descend --log-file sparse-matrix-benchmark-descend-float.log --stop-time $STOP_TIME --verbose 1
      fi
      if test ! -e $unzipped_matrix.descend.double.bin.bz2;
      then
         echo "Missing $unzipped_matrix.descend.double.bin.bz2 !!! Run the script 'convert-matrices'."
      else
         echo "Checking with the matrix $unzipped_matrix.descend in double precison ..."
         export CUDA_PROFILE_LOG=$unzipped_matrix.descend.double.log 
         $SPARSE_MATRIX_BENCHMARK --input-file $unzipped_matrix.descend.double.bin.bz2 --input-mtx-file $unzipped_matrix.descend --log-file sparse-matrix-benchmark-descend-double.log --stop-time $STOP_TIME --verbose 1
      fi
      #######
      ## AMD ordering
      ###  
      if test ! -e $unzipped_matrix.amd.float.bin.bz2;
      then
         echo "Missing $unzipped_matrix.amd.float.bin.bz2 !!! Run the script 'convert-matrices'."
      else
         echo "Checking with the matrix $unzipped_matrix.amd in single precision ..."
         export CUDA_PROFILE_LOG=$unzipped_matrix.amd.float.log
         $SPARSE_MATRIX_BENCHMARK --input-file $unzipped_matrix.amd.float.bin.bz2 --input-mtx-file $unzipped_matrix.amd --log-file sparse-matrix-benchmark-amd-float.log --stop-time $STOP_TIME --verbose 1
      fi
      if test ! -e $unzipped_matrix.amd.double.bin.bz2;
      then
         echo "Missing $unzipped_matrix.amd.double.bin.bz2 !!! Run the script 'convert-matrices'."
      else
         echo "Checking with the matrix $unzipped_matrix.amd in double precison ..."
         export CUDA_PROFILE_LOG=$unzipped_matrix.amd.double.log 
         $SPARSE_MATRIX_BENCHMARK --input-file $unzipped_matrix.amd.double.bin.bz2 --input-mtx-file $unzipped_matrix.amd --log-file sparse-matrix-benchmark-amd-double.log --stop-time $STOP_TIME --verbose 1
      fi
          
   fi
done

for link in $FLORIDA_MM_MATRICES;
do
   matrix=matrices`echo $link | sed 's/http:\/\/www.cise.ufl.edu\/research\/sparse//'`
   if test ! -e $matrix;
   then      
      echo "Matrix $matrix is missing !!! Run the script 'get-matrices' first."
      #echo "Matrix $matrix is missing !!! Run the script 'get-matrices' first." >> sparse-matrix-benchmark.log
   else
     DIRNAME=`dirname $matrix`
     FILENAME=`basename $matrix`
     cd $DIRNAME
     tar zxvf $FILENAME
     cd $IWD
     SUBDIRNAME=`echo $FILENAME | sed 's/.tar.gz//'`
     rm -f $DIRNAME/$SUBDIRNAME/*_b.mtx # these are usualy in array format
     for file in $DIRNAME/$SUBDIRNAME/*.mtx;
     do
         echo "###############################################################################################"
         if test ! -e $file.float.bin.bz2;
         then
            echo "Missing $file.float.bin.bz2 !!! Run the script 'convert-matrices'."
         else   
            echo "Checking with the matrix $file ..."
            $SPARSE_MATRIX_BENCHMARK --input-file $file.float.bin.bz2 --input-mtx-file $file --log-file sparse-matrix-benchmark-float.log --stop-time $STOP_TIME --verbose 1                        
         fi
         if test ! -e $file.double.bin.bz2;
         then
            echo "Missing $file.double.bin.bz2 !!! Run the script 'convert-matrices'."
         else   
            echo "Checking with the matrix $file ..."
            $SPARSE_MATRIX_BENCHMARK --input-file $file.double.bin.bz2 --input-mtx-file $file --log-file sparse-matrix-benchmark-double.log --stop-time $STOP_TIME --verbose 1                        
         fi                           
         #######
         ## Descend ordering
         ###  
         if test ! -e $file.descend.float.bin.bz2;
         then
            echo "Missing $file.descend.float.bin.bz2 !!! Run the script 'convert-matrices'."
         else   
            echo "Checking with the matrix $file.descend ..."
            $SPARSE_MATRIX_BENCHMARK --input-file $file.descend.float.bin.bz2 --input-mtx-file $file.descend --log-file sparse-matrix-benchmark-descend-float.log --stop-time $STOP_TIME --verbose 1                        
         fi
         if test ! -e $file.descend.double.bin.bz2;
         then
            echo "Missing $file.descend.double.bin.bz2 !!! Run the script 'convert-matrices'."
         else   
            echo "Checking with the matrix $file ..."
            $SPARSE_MATRIX_BENCHMARK --input-file $file.descend.double.bin.bz2 --input-mtx-file $file.descend --log-file sparse-matrix-benchmark-descend-double.log --stop-time $STOP_TIME --verbose 1                        
         fi                           
         #######
         ## AMD ordering
         ###  
         if test ! -e $file.amd.float.bin.bz2;
         then
            echo "Missing $file.amd.float.bin.bz2 !!! Run the script 'convert-matrices'."
         else   
            echo "Checking with the matrix $file.amd ..."
            $SPARSE_MATRIX_BENCHMARK --input-file $file.amd.float.bin.bz2 --input-mtx-file $file.amd --log-file sparse-matrix-benchmark-amd-float.log --stop-time $STOP_TIME --verbose 1                        
         fi
         if test ! -e $file.amd.double.bin.bz2;
         then
            echo "Missing $file.amd.double.bin.bz2 !!! Run the script 'convert-matrices'."
         else   
            echo "Checking with the matrix $file ..."
            $SPARSE_MATRIX_BENCHMARK --input-file $file.amd.double.bin.bz2 --input-mtx-file $file.amd --log-file sparse-matrix-benchmark-amd-double.log --stop-time $STOP_TIME --verbose 1                        
         fi                           
         rm $file         
      done
   fi
done
